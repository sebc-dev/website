name: E2E Reminder for Main

on:
  pull_request:
    types: [opened, ready_for_review]
    branches: [main]

jobs:
  e2e-reminder:
    name: Remind to run E2E tests
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    permissions:
      pull-requests: write
      statuses: write

    steps:
      - name: Check if E2E already ran
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            const e2eStatus = statuses.find(s => s.context === 'e2e/preview-deployment');
            const hasRun = e2eStatus && (e2eStatus.state === 'success' || e2eStatus.state === 'failure');

            core.setOutput('has_run', hasRun);
            core.setOutput('status', e2eStatus?.state || 'none');

      - name: Create pending status check
        if: steps.check.outputs.has_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'pending',
              description: 'E2E tests required before merge - Comment @e2e to run',
              context: 'e2e/preview-deployment'
            });

      - name: Comment with instructions
        if: steps.check.outputs.has_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸ§ª E2E Tests Required

            This PR targets \`main\` and requires E2E tests to pass before merging.

            **To run E2E tests**, comment on this PR:
            \`\`\`
            @e2e
            \`\`\`

            The tests will run on a Cloudflare preview deployment and the results will be reported here.

            ---
            *This check is required for merging to \`main\`. See [ADR-001](../docs/decisions/001-e2e-tests-preview-deployments.md) for details.*`;

            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
