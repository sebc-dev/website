name: E2E Tests Report (Privileged)

# This workflow handles privileged actions (status checks, comments)
# It NEVER checks out or executes untrusted code from PRs

on:
  workflow_run:
    workflows: ['E2E Tests (Unprivileged)']
    types: [completed]

jobs:
  report:
    name: Post Test Results
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'cancelled'

    # Full write permissions - safe because we never execute untrusted code
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    steps:
      - name: Download test metadata
        uses: actions/download-artifact@v4
        with:
          name: test-metadata-*
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read test metadata
        id: metadata
        run: |
          # Find the metadata file
          METADATA_FILE=$(find . -name "metadata.json" -type f | head -1)

          if [ ! -f "$METADATA_FILE" ]; then
            echo "Error: metadata.json not found"
            exit 1
          fi

          # Parse metadata
          PR_NUMBER=$(jq -r '.pr_number' "$METADATA_FILE")
          PR_SHA=$(jq -r '.pr_sha' "$METADATA_FILE")
          DEPLOYMENT_URL=$(jq -r '.deployment_url' "$METADATA_FILE")
          TEST_STATUS=$(jq -r '.test_status' "$METADATA_FILE")
          WORKFLOW_RUN_ID=$(jq -r '.workflow_run_id' "$METADATA_FILE")
          TRIGGERED_BY=$(jq -r '.triggered_by' "$METADATA_FILE")

          # Set outputs
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT
          echo "workflow_run_id=$WORKFLOW_RUN_ID" >> $GITHUB_OUTPUT
          echo "triggered_by=$TRIGGERED_BY" >> $GITHUB_OUTPUT

      - name: Create status check (pending)
        uses: actions/github-script@v7
        env:
          PR_SHA: ${{ steps.metadata.outputs.pr_sha }}
          WORKFLOW_RUN_ID: ${{ steps.metadata.outputs.workflow_run_id }}
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.PR_SHA,
              state: 'pending',
              target_url: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${process.env.WORKFLOW_RUN_ID}`,
              description: 'E2E tests running on preview deployment',
              context: 'e2e/preview-deployment'
            });

      - name: Update status check (success)
        if: steps.metadata.outputs.test_status == 'success'
        uses: actions/github-script@v7
        env:
          PR_SHA: ${{ steps.metadata.outputs.pr_sha }}
          WORKFLOW_RUN_ID: ${{ steps.metadata.outputs.workflow_run_id }}
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.PR_SHA,
              state: 'success',
              target_url: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${process.env.WORKFLOW_RUN_ID}`,
              description: 'E2E tests passed âœ…',
              context: 'e2e/preview-deployment'
            });

      - name: Update status check (failure)
        if: steps.metadata.outputs.test_status != 'success'
        uses: actions/github-script@v7
        env:
          PR_SHA: ${{ steps.metadata.outputs.pr_sha }}
          WORKFLOW_RUN_ID: ${{ steps.metadata.outputs.workflow_run_id }}
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.PR_SHA,
              state: 'failure',
              target_url: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${process.env.WORKFLOW_RUN_ID}`,
              description: 'E2E tests failed âŒ',
              context: 'e2e/preview-deployment'
            });

      - name: Comment PR with results
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_URL: ${{ steps.metadata.outputs.deployment_url }}
          TEST_STATUS: ${{ steps.metadata.outputs.test_status }}
          WORKFLOW_RUN_ID: ${{ steps.metadata.outputs.workflow_run_id }}
          TRIGGERED_BY: ${{ steps.metadata.outputs.triggered_by }}
          PR_NUMBER: ${{ steps.metadata.outputs.pr_number }}
        with:
          script: |
            const deploymentUrl = process.env.DEPLOYMENT_URL;
            const testsPassed = process.env.TEST_STATUS === 'success';
            const workflowRunId = process.env.WORKFLOW_RUN_ID;
            const triggeredBy = process.env.TRIGGERED_BY;

            const body = testsPassed
              ? `âœ… E2E tests passed on preview deployment!\n\nðŸ“¦ Preview URL: ${deploymentUrl}\n\n*Triggered by @${triggeredBy}*`
              : `âŒ E2E tests failed on preview deployment.\n\nðŸ“¦ Preview URL: ${deploymentUrl}\n\nCheck the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${workflowRunId}) for details.\n\n*Triggered by @${triggeredBy}*`;

            await github.rest.issues.createComment({
              issue_number: parseInt(process.env.PR_NUMBER),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Add reaction to trigger comment
        if: github.event.workflow_run.event == 'issue_comment'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.metadata.outputs.pr_number }}
          TRIGGERED_BY: ${{ steps.metadata.outputs.triggered_by }}
        with:
          script: |
            // Get the original issue_comment event
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.PR_NUMBER)
            });

            // Find the comment that triggered the workflow (contains @e2e)
            const triggerComment = comments.find(c =>
              c.body.includes('@e2e') &&
              c.user.login === process.env.TRIGGERED_BY
            );

            if (triggerComment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: triggerComment.id,
                content: 'rocket'
              });
            }
