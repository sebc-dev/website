name: Configuration Validation

on:
  pull_request:
    branches: [main, dev, develop]
  push:
    branches: [main, dev, develop]
  workflow_dispatch: # Allow manual trigger

# Permissions minimales
permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Environment Variables Validation
  # ==========================================================================
  # Validates consistency between .env.example, GitHub workflows, and code
  # Ensures all secrets are documented and used correctly
  # ==========================================================================
  validate-env-vars:
    name: Validate Environment Variables
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Run environment variables validation
        run: node scripts/validate-env-vars.cjs

  # ==========================================================================
  # Dependency Placement Check
  # ==========================================================================
  # Ensures packages are in the correct section (dependencies vs devDependencies)
  # Prevents runtime errors from missing production dependencies
  # ==========================================================================
  validate-dependency-placement:
    name: Validate Dependency Placement
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Check for runtime imports in devDependencies
        run: |
          echo "üîç Checking for runtime imports from devDependencies..."

          # List of files to check for imports (runtime code)
          # Exclude test files (*.test.*, *.spec.*)
          RUNTIME_FILES=$(find app lib src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) ! -name "*.test.*" ! -name "*.spec.*" 2>/dev/null || true)

          if [ -z "$RUNTIME_FILES" ]; then
            echo "‚úÖ No runtime files found to check"
            exit 0
          fi

          # Extract devDependencies from package.json
          DEV_DEPS=$(node -pe "Object.keys(require('./package.json').devDependencies || {}).join('|')" || echo "")

          if [ -z "$DEV_DEPS" ]; then
            echo "‚úÖ No devDependencies to check"
            exit 0
          fi

          # Check for imports of devDependencies in runtime code
          ISSUES_FOUND=0

          for file in $RUNTIME_FILES; do
            # Check for import statements
            MATCHES=$(grep -nE "from ['\"]($DEV_DEPS)['\"]|require\(['\"]($DEV_DEPS)['\"]\)" "$file" || true)

            if [ -n "$MATCHES" ]; then
              echo "‚ùå Runtime import of devDependency in $file:"
              echo "$MATCHES"
              ISSUES_FOUND=1
            fi
          done

          if [ $ISSUES_FOUND -eq 1 ]; then
            echo ""
            echo "‚ùå ERROR: Runtime code imports devDependencies"
            echo "üí° Move these packages to 'dependencies' in package.json"
            exit 1
          fi

          echo "‚úÖ All dependency placements are correct"

  # ==========================================================================
  # Wrangler Configuration Check
  # ==========================================================================
  # Validates wrangler.jsonc configuration for:
  # - nodejs_compat flag (CRITICAL for Next.js compatibility)
  # - Binding configuration (D1, R2, KV, Durable Objects)
  # - Compatibility date (should be recent)
  # - Worker name and service bindings
  # ==========================================================================
  validate-wrangler:
    name: Validate Wrangler Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Validate Wrangler Configuration
        run: bash scripts/validate-wrangler-config.sh

  # ==========================================================================
  # TypeScript Configuration Check
  # ==========================================================================
  # Validates TypeScript compiles without errors
  # Catches type errors before they reach production
  # ==========================================================================
  validate-typescript:
    name: Validate TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          install-pnpm: 'true'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript compiler
        run: pnpm tsc --noEmit

  # ==========================================================================
  # Summary Job
  # ==========================================================================
  # Aggregates all validation results
  # Provides a single status check for branch protection
  # ==========================================================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - validate-env-vars
      - validate-dependency-placement
      - validate-wrangler
      - validate-typescript
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "üìä Validation Results:"
          echo "  Package Versions: DISABLED (Cloudflare constraints)"
          echo "  Environment Variables: ${{ needs.validate-env-vars.result }}"
          echo "  Dependency Placement: ${{ needs.validate-dependency-placement.result }}"
          echo "  Wrangler Configuration: ${{ needs.validate-wrangler.result }}"
          echo "  TypeScript: ${{ needs.validate-typescript.result }}"

          if [ "${{ needs.validate-env-vars.result }}" != "success" ] || \
             [ "${{ needs.validate-dependency-placement.result }}" != "success" ] || \
             [ "${{ needs.validate-wrangler.result }}" != "success" ] || \
             [ "${{ needs.validate-typescript.result }}" != "success" ]; then
            echo ""
            echo "‚ùå Some validations failed"
            exit 1
          fi

          echo ""
          echo "‚úÖ All validations passed"
