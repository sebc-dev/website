# GitHub Actions Workflow for Deployment to Cloudflare Workers
#
# Purpose:
# This workflow automates the deployment of the Next.js application to Cloudflare Workers.
# It serves as the final stage in the CI/CD pipeline after all quality checks pass.
#
# Triggers:
# - Manual dispatch (workflow_dispatch) for on-demand deployments
# - Automatic trigger after successful quality checks (workflow_run)
#
# Phases:
# 1. Structure (Commit 1): Workflow file setup with permissions and concurrency
# 2. Triggers (Commit 2): Add workflow_dispatch and workflow_run triggers
# 3. Deployment (Commit 3): Configure Cloudflare Workers deployment
# 4. Verification (Commit 4): Add post-deployment health checks
# 5. Logging (Commit 5): Add deployment artifacts and summary

name: Deploy to Cloudflare Workers

# ============================================================================
# Triggers Configuration (Commit 2)
# ============================================================================
#
# This workflow supports two trigger mechanisms:
#
# 1. Manual Deployment (workflow_dispatch)
#    - Allows developers to trigger deployments on-demand
#    - Optional inputs for skip_verification and dry_run
#    - Useful for emergency deployments or testing
#
# 2. Automatic Deployment (workflow_run)
#    - Triggers after quality checks pass successfully
#    - Limited to main/develop branches to avoid deploying feature branches
#    - Ensures code quality before production deployment
#    - Dependency: quality workflow must complete successfully
#
on:
  workflow_dispatch:
    description: "Manually trigger deployment to Cloudflare Workers"
    inputs:
      skip_verification:
        description: "Skip health check verification after deployment (use with caution)"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Run deployment steps without actually deploying (for testing)"
        required: false
        type: boolean
        default: false

  workflow_run:
    workflows: ["Quality Checks"]
    types: [completed]
    branches:
      - main
      - develop

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  DEPLOYMENT_TIMEOUT: 15m

jobs:
  # ============================================================================
  # Check workflow trigger status (Commit 2)
  # ============================================================================
  #
  # For workflow_run triggers: Only proceed if quality workflow succeeded
  # For manual triggers: Always proceed
  #
  check-trigger:
    name: Validate Workflow Trigger
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      should-deploy: ${{ steps.trigger-check.outputs.should-deploy }}
      trigger-type: ${{ steps.trigger-check.outputs.trigger-type }}

    steps:
      - name: Check trigger type
        id: trigger-check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "trigger-type=manual" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "Trigger Type: Manual Deployment (workflow_dispatch)"
            echo "Skip Verification: ${{ github.event.inputs.skip_verification }}"
            echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
              echo "trigger-type=automatic" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "Trigger Type: Automatic Deployment (workflow_run)"
              echo "Quality workflow completed successfully on branch: ${{ github.event.workflow_run.head_branch }}"
            else
              echo "trigger-type=automatic" >> $GITHUB_OUTPUT
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "Quality workflow failed. Deployment will not proceed."
            fi
          else
            echo "trigger-type=unknown" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Deployment Job (Commit 3: Cloudflare Workers Deployment)
  # ============================================================================
  #
  # This job handles the complete deployment process:
  # 1. Checkout code
  # 2. Setup environment (pnpm, Node.js)
  # 3. Install dependencies with locked versions
  # 4. Build the application (OpenNext adapter for Cloudflare Workers)
  # 5. Deploy to Cloudflare Workers using wrangler-action
  #
  # Security: Uses GitHub secrets for API token and account ID
  # Timeout: 10 minutes to prevent hanging deployments
  #
  deploy:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: check-trigger
    if: needs.check-trigger.outputs.should-deploy == 'true'

    steps:
      # ========================================================================
      # Step 1: Checkout Code
      # ========================================================================
      # Clone the repository at the commit being deployed
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================================================
      # Step 2: Setup pnpm
      # ========================================================================
      # Configure pnpm package manager
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.0.0"

      # ========================================================================
      # Step 3: Setup Node.js
      # ========================================================================
      # Install Node.js and configure pnpm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "pnpm"

      # ========================================================================
      # Step 4: Install Dependencies
      # ========================================================================
      # Install dependencies with frozen lockfile to ensure reproducible builds
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ========================================================================
      # Step 5: Build Application
      # ========================================================================
      # Build Next.js application with OpenNext adapter for Cloudflare Workers
      # Output: .open-next/ directory containing the worker and assets
      - name: Build application
        run: pnpm build

      # ========================================================================
      # Step 6: Deploy to Cloudflare Workers
      # ========================================================================
      # Deploy the built application to Cloudflare Workers using wrangler-action
      # Secrets are passed securely and not exposed in logs
      #
      # Action: cloudflare/wrangler-action@v3 (official Cloudflare action)
      # API Token: Required secret (CLOUDFLARE_API_TOKEN) with Workers Deploy permission
      # Account ID: Required secret (CLOUDFLARE_ACCOUNT_ID)
      # Command: wrangler deploy (deploys the worker from .open-next/)
      #
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
