# Phase 2 - Environment Setup

This guide covers all environment setup needed for Phase 2: Core Database Schema (Articles & Translations).

---

## ğŸ“‹ Prerequisites

### Previous Phases
- [x] **Phase 1 completed and validated** - Drizzle ORM installed, D1 configured, connection tested

### Tools Required
- [x] **Node.js** (v18+)
- [x] **pnpm** (v8+)
- [x] **Wrangler CLI** (v3+) - Cloudflare Workers CLI
- [x] **TypeScript** (v5+)

### Services Required
- [x] **Cloudflare D1 local database** - Running via Wrangler/Miniflare
- [x] **Drizzle Kit** - Installed and configured

---

## ğŸ“¦ Dependencies Installation

### Verify Existing Packages

All dependencies should already be installed from Phase 1. Verify they exist:

```bash
# Check package.json for these dependencies
cat package.json | grep -A 5 "dependencies\|devDependencies"
```

**Required packages** (from Phase 1):
- `drizzle-orm` - ORM for type-safe database queries
- `@cloudflare/d1` - Cloudflare D1 database bindings (included in Drizzle)
- `drizzle-kit` (devDependency) - Migration generation and management

### No New Packages

Phase 2 does not require any new package installations. All schema work uses the existing Drizzle ORM setup.

### Verify Installation

```bash
# Verify Drizzle is installed
pnpm list drizzle-orm
pnpm list drizzle-kit

# Expected output:
# drizzle-orm <version>
# drizzle-kit <version>
```

---

## ğŸ”§ Environment Variables

### Required Variables

Phase 2 uses the same environment variables as Phase 1. Verify they exist in `.env` or `.env.local`:

```env
# Cloudflare Configuration (for remote D1 access)
CLOUDFLARE_ACCOUNT_ID=your_account_id_here
CLOUDFLARE_DATABASE_ID=your_database_id_here
CLOUDFLARE_API_TOKEN=your_api_token_here
```

### Variable Descriptions

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `CLOUDFLARE_ACCOUNT_ID` | Cloudflare account ID for D1 access | `abc123def456` | Yes (remote only) |
| `CLOUDFLARE_DATABASE_ID` | D1 database ID from `wrangler d1 create` | `xyz789abc123` | Yes (remote only) |
| `CLOUDFLARE_API_TOKEN` | API token with D1 permissions | `token_value` | Yes (remote only) |

**Note**: For local development with `wrangler dev` or `pnpm db:migrate:local`, these are not strictly required. Wrangler uses the binding from `wrangler.toml`.

---

## ğŸ—„ï¸ Database Setup

### Local D1 Database

**Purpose**: Local SQLite database for development and testing

**Setup Steps** (should already be done in Phase 1):

1. **Verify D1 binding in wrangler.toml**:
```bash
cat wrangler.toml | grep -A 3 "d1_databases"
```

Expected output:
```toml
[[d1_databases]]
binding = "DB"
database_name = "sebc-dev-db"
database_id = "..."  # Generated by wrangler d1 create
```

2. **Verify local database exists**:
```bash
# Local D1 database persists in .wrangler/state/d1/
ls .wrangler/state/d1/
```

3. **Test connection** (from Phase 1):
```bash
wrangler d1 execute DB --local --command="SELECT 1 as test;"
```

**Expected Output**: `{"test":1}`

---

## âœ… Drizzle Configuration

### Verify drizzle.config.ts

Phase 2 uses the Drizzle configuration from Phase 1. Verify it exists and is correct:

```bash
cat drizzle.config.ts
```

**Expected configuration**:
```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/lib/server/db/schema.ts',
  out: './drizzle/migrations',
  dialect: 'sqlite',
  driver: 'd1-http',
  dbCredentials: {
    accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
    databaseId: process.env.CLOUDFLARE_DATABASE_ID!,
    token: process.env.CLOUDFLARE_API_TOKEN!,
  },
} satisfies Config;
```

**Key points**:
- `schema`: Points to where we'll create the schema in Phase 2 (`src/lib/server/db/schema.ts`)
- `out`: Migration output directory
- `dialect`: 'sqlite' (D1 is SQLite-based)
- `dbCredentials`: Used for remote migrations (not local)

---

## ğŸ“Š Directory Structure

### Create Required Directories

Phase 2 will create new files in these directories:

```bash
# Create directories if they don't exist
mkdir -p src/lib/server/db
mkdir -p drizzle/seeds
mkdir -p tests/integration
```

**Directory structure** after Phase 2:
```
/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ server/
â”‚           â””â”€â”€ db/
â”‚               â””â”€â”€ schema.ts (NEW in Commit 1-3)
â”œâ”€â”€ drizzle/
â”‚   â”œâ”€â”€ migrations/ (NEW SQL in Commit 4)
â”‚   â”‚   â”œâ”€â”€ 0001_***.sql
â”‚   â”‚   â””â”€â”€ meta/
â”‚   â”‚       â””â”€â”€ _journal.json
â”‚   â””â”€â”€ seeds/ (NEW in Commit 5)
â”‚       â””â”€â”€ sample-articles.sql
â””â”€â”€ tests/
    â””â”€â”€ integration/ (NEW in Commit 6)
        â””â”€â”€ articles-schema.test.ts
```

---

## âœ… npm Scripts Verification

### Verify Existing Scripts

From Phase 1, these scripts should exist in `package.json`:

```bash
cat package.json | grep -A 10 '"scripts"'
```

**Required scripts**:
```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate",
    "db:migrate:local": "wrangler d1 migrations apply DB --local",
    "db:migrate:remote": "wrangler d1 migrations apply DB --remote",
    "db:studio": "drizzle-kit studio"
  }
}
```

### New Script Added in Phase 2

In Commit 5, we'll add:
```json
"db:seed:articles": "wrangler d1 execute DB --local --file=./drizzle/seeds/sample-articles.sql"
```

---

## ğŸ§ª Connection Tests

### Test Local D1 Connection

Before starting Phase 2 implementation, verify the database is accessible:

```bash
# Test 1: Execute simple query
wrangler d1 execute DB --local --command="SELECT 1 as test;"
```

**Expected Result**: `{"test":1}`

```bash
# Test 2: List existing tables (should be empty or only __drizzle_migrations)
wrangler d1 execute DB --local --command="SELECT name FROM sqlite_master WHERE type='table';"
```

**Expected Result**: Empty or `__drizzle_migrations` table only

```bash
# Test 3: Verify Drizzle Kit can connect
pnpm db:studio
```

**Expected Result**: Drizzle Studio launches on http://localhost:4983 (or similar port)

---

## ğŸš¨ Troubleshooting

### Issue: wrangler d1 execute fails with "database not found"

**Symptoms**:
- Error: `Database 'DB' not found`
- Commands fail to execute

**Solutions**:
1. **Verify wrangler.toml binding**:
   ```bash
   cat wrangler.toml | grep -A 3 "d1_databases"
   ```
   Ensure binding name is "DB" and database_name/database_id are set.

2. **Recreate local database**:
   ```bash
   # Delete .wrangler directory
   rm -rf .wrangler

   # Run dev server to recreate
   pnpm dev
   ```

3. **Check Wrangler version**:
   ```bash
   wrangler --version
   # Should be v3+
   ```

**Verify Fix**:
```bash
wrangler d1 execute DB --local --command="SELECT 1;"
```

---

### Issue: drizzle-kit generate fails

**Symptoms**:
- Error: `Could not find schema file`
- Error: `Invalid configuration`

**Solutions**:
1. **Verify drizzle.config.ts exists**:
   ```bash
   ls drizzle.config.ts
   ```

2. **Check schema path**:
   ```typescript
   // In drizzle.config.ts, verify:
   schema: './src/lib/server/db/schema.ts'
   ```

3. **Ensure schema file exists** (after Commit 1):
   ```bash
   ls src/lib/server/db/schema.ts
   ```

**Verify Fix**:
```bash
pnpm db:generate
# Should generate migration or say "No schema changes"
```

---

### Issue: Migration apply fails

**Symptoms**:
- Error: `SQL error` or `syntax error`
- Migration hangs or times out

**Solutions**:
1. **Review generated SQL**:
   ```bash
   cat drizzle/migrations/0001_*.sql
   ```
   Check for syntax errors or invalid SQLite commands.

2. **Test SQL manually**:
   ```bash
   wrangler d1 execute DB --local --file=./drizzle/migrations/0001_*.sql
   ```

3. **Reset local database** (nuclear option):
   ```bash
   rm -rf .wrangler/state/d1/
   pnpm dev  # Recreates database
   ```

**Verify Fix**:
```bash
pnpm db:migrate:local
# Should apply successfully
```

---

### Issue: TypeScript errors in schema.ts

**Symptoms**:
- `Cannot find module 'drizzle-orm/sqlite-core'`
- Type errors in table definitions

**Solutions**:
1. **Reinstall dependencies**:
   ```bash
   pnpm install
   ```

2. **Verify imports**:
   ```typescript
   import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
   ```

3. **Check TypeScript version**:
   ```bash
   pnpm list typescript
   # Should be v5+
   ```

**Verify Fix**:
```bash
pnpm tsc --noEmit
# Should show no errors
```

---

## ğŸ“ Setup Checklist

Complete this checklist before starting Phase 2 implementation:

- [ ] Phase 1 completed and validated
- [ ] All dependencies installed (drizzle-orm, drizzle-kit)
- [ ] Environment variables configured (if using remote D1)
- [ ] wrangler.toml has D1 binding configured
- [ ] Local D1 database accessible
- [ ] drizzle.config.ts exists and is correct
- [ ] npm scripts work (db:generate, db:migrate:local, db:studio)
- [ ] Connection tests pass
- [ ] Directories created (src/lib/server/db, drizzle/seeds, tests/integration)
- [ ] No errors in logs

**Environment is ready for Phase 2! ğŸš€**

---

## ğŸ”— Related Documentation

- [Phase 1 - Environment Setup](../phase_1/ENVIRONMENT_SETUP.md)
- [Drizzle ORM Documentation](https://orm.drizzle.team/docs/overview)
- [Cloudflare D1 Documentation](https://developers.cloudflare.com/d1/)
- [Wrangler CLI Documentation](https://developers.cloudflare.com/workers/wrangler/)
