# Environment Variables for Deployment

This document provides comprehensive information about environment variables used for deploying to Cloudflare Workers.

## Quick Reference

| Variable                 | Type     | Scope              | Required | Auto-Generated | Purpose                                     |
| ------------------------ | -------- | ------------------ | -------- | -------------- | ------------------------------------------- |
| `CLOUDFLARE_WORKER_NAME` | Secret   | GitHub Environment | ‚úÖ YES   | ‚ùå NO          | Specifies which Cloudflare Worker to deploy |
| `WORKER_URL`             | Variable | CI/CD Output       | ‚ùå NO    | ‚úÖ YES         | Full URL of the deployed Worker             |
| `CLOUDFLARE_API_TOKEN`   | Secret   | GitHub Environment | ‚úÖ YES   | ‚ùå NO          | Authentication token for Cloudflare API     |
| `CLOUDFLARE_ACCOUNT_ID`  | Secret   | GitHub Environment | ‚úÖ YES   | ‚ùå NO          | Your Cloudflare account ID                  |

---

## CLOUDFLARE_WORKER_NAME (Required Input)

### What It Is

A GitHub Environment Secret that specifies the **name of the Cloudflare Worker** to deploy for a specific environment (e.g., production, staging).

### Why It Matters

- **Environment-Specific Deployment**: Different environments (staging vs production) can have different worker names
- **Safety**: Explicitly names the target worker to prevent accidental deployments to wrong workers
- **Configuration**: Must match the `"name"` field in `wrangler.jsonc` for production deployments

### Configuration

#### Setup in GitHub

1. Go to your GitHub repository
2. Navigate to **Settings** ‚Üí **Environments** ‚Üí **production**
3. Under "Environment secrets", add a new secret:
   - **Name**: `CLOUDFLARE_WORKER_NAME`
   - **Value**: Your worker name (e.g., `website` for production)

#### For Staging Environment (Optional)

If you have a staging environment:

1. Create a new GitHub Environment called **staging** (if not exists)
2. Add the same secret with a different value (e.g., `website-staging`)
3. Update your deployment workflow to deploy to the staging environment when needed

#### Format Requirements

- **Type**: Alphanumeric string with hyphens allowed
- **Examples**:
  - `website` (production)
  - `website-staging` (staging)
  - `website-dev` (development)
- **Constraint**: Must exactly match the `"name"` field in `wrangler.jsonc`

### Local Development

For local testing, you can temporarily export this variable:

```bash
export CLOUDFLARE_WORKER_NAME="website"
```

### Validation

The deployment workflow automatically validates that:

1. `CLOUDFLARE_WORKER_NAME` is configured
2. The value matches the `"name"` field in `wrangler.jsonc`
3. If validation fails, the workflow stops with clear error messages

**Script Reference**: `scripts/build-worker-url.sh`

---

## WORKER_URL (Auto-Generated Output)

### What It Is

The **fully qualified URL** of your deployed Cloudflare Worker. This is automatically generated by the deployment workflow using the formula:

```
https://<CLOUDFLARE_WORKER_NAME>.<ACCOUNT_SUBDOMAIN>.workers.dev
```

### Example

If:

- `CLOUDFLARE_WORKER_NAME` = `website`
- Account subdomain = `chauveau-sebastien`

Then:

- `WORKER_URL` = `https://website.chauveau-sebastien.workers.dev`

### Where It's Used

1. **Health Checks**: Verifies the deployed Worker is responsive (HTTP 200)
2. **Deployment Summaries**: Displayed in GitHub Actions job summary
3. **Notifications**: Used in deployment status reports
4. **GitHub Deployments**: Linked as the environment URL in GitHub UI

### How It's Generated

The deployment workflow uses the centralized script `scripts/build-worker-url.sh` to:

1. Read `CLOUDFLARE_WORKER_NAME` from GitHub secrets
2. Extract the worker name from `wrangler.jsonc`
3. Validate they match (strict consistency check)
4. Construct the full URL
5. Perform health checks against the URL

### Account Subdomain

The account subdomain (`chauveau-sebastien` in this project) is:

- **Currently**: Hardcoded in deployment scripts
- **From**: Your Cloudflare account dashboard (bottom-left of dash.cloudflare.com)
- **Change**: If you change Cloudflare accounts, update `scripts/build-worker-url.sh` and GitHub workflow

---

## CLOUDFLARE_API_TOKEN (Required Secret)

### What It Is

An API token for authenticating with Cloudflare's API. Required to deploy your Worker.

### Configuration

#### In GitHub (Production Environment)

1. Go to **Settings** ‚Üí **Environments** ‚Üí **production**
2. Add environment secret:
   - **Name**: `CLOUDFLARE_API_TOKEN`
   - **Value**: [Your Cloudflare API token]

#### In Local .env File (Development Only)

For local development and database operations, create `.env`:

```bash
# Copy from .env.example
cp .env.example .env

# Edit .env with your actual token
CLOUDFLARE_API_TOKEN=your_api_token_here
```

### Creating an API Token

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com)
2. Profile ‚Üí API Tokens ‚Üí Create Token
3. Create custom token with permissions:
   - **Account** ‚Üí **Cloudflare D1** ‚Üí **Edit**
   - **Account** ‚Üí **Workers Scripts** ‚Üí **Edit**
4. Copy the token and add to GitHub Environments

### Security Best Practices

- ‚ö†Ô∏è **Never commit** `.env` files to git
- ‚ö†Ô∏è **Never share** your API token
- üîÑ **Rotate regularly** (every 90 days recommended)
- üîê **Use scoped tokens** with minimal required permissions
- üìã **Enable audit logs** to track token usage

---

## CLOUDFLARE_ACCOUNT_ID (Required Secret)

### What It Is

Your Cloudflare account ID (UUID format). Required for API authentication.

### Configuration

#### In GitHub (Production Environment)

1. Go to **Settings** ‚Üí **Environments** ‚Üí **production**
2. Add environment secret:
   - **Name**: `CLOUDFLARE_ACCOUNT_ID`
   - **Value**: [Your account ID]

#### In Local .env File (Development Only)

```bash
CLOUDFLARE_ACCOUNT_ID=your_account_id_here
```

### Finding Your Account ID

**Method 1: Cloudflare Dashboard**

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com)
2. Click your profile (bottom-left)
3. Look for "Account ID" in the sidebar
4. Copy the UUID

**Method 2: Wrangler CLI**

```bash
wrangler whoami
```

---

## Setup Checklist

Use this checklist when setting up a new environment or troubleshooting configuration issues.

### Prerequisites

- [ ] Cloudflare account with a Worker created
- [ ] GitHub repository with Actions enabled
- [ ] Cloudflare API token with appropriate permissions

### GitHub Environment Setup

For **production** environment (or your target environment):

- [ ] Navigate to: **Settings** ‚Üí **Environments** ‚Üí **production**
- [ ] Add secret: `CLOUDFLARE_WORKER_NAME` = your worker name
- [ ] Add secret: `CLOUDFLARE_API_TOKEN` = your API token
- [ ] Add secret: `CLOUDFLARE_ACCOUNT_ID` = your account ID

### Configuration Validation

- [ ] `CLOUDFLARE_WORKER_NAME` matches the `"name"` field in `wrangler.jsonc`
- [ ] `CLOUDFLARE_API_TOKEN` has "Workers Scripts > Edit" permission
- [ ] `CLOUDFLARE_ACCOUNT_ID` is correctly formatted (UUID)
- [ ] GitHub branch protection rules are configured (if using required reviewers)

### Deployment Test

- [ ] Run deployment workflow manually via GitHub Actions
- [ ] Check workflow logs for validation messages
- [ ] Verify worker URL is accessible (should show HTTP 200)
- [ ] Test worker functionality after deployment

---

## Multi-Environment Setup

### Production + Staging

If you need separate production and staging deployments:

#### Step 1: Create Staging Environment in GitHub

1. Go to **Settings** ‚Üí **Environments** ‚Üí **New Environment**
2. Name: `staging`
3. Add secrets:
   - `CLOUDFLARE_WORKER_NAME` = `website-staging`
   - `CLOUDFLARE_API_TOKEN` = (same as production)
   - `CLOUDFLARE_ACCOUNT_ID` = (same as production)

#### Step 2: Create Corresponding Worker in Cloudflare

```bash
wrangler deploy --name website-staging
```

#### Step 3: Update Deployment Workflow (Optional)

You can configure different workflows for different environments or use conditional logic in GitHub Actions.

---

## Troubleshooting

### Issue: "CLOUDFLARE_WORKER_NAME not configured"

**Cause**: Environment secret is missing or not accessible

**Solution**:

1. Go to **Settings** ‚Üí **Environments** ‚Üí **production**
2. Verify `CLOUDFLARE_WORKER_NAME` exists
3. Check that the deployment job specifies `environment: production`

### Issue: "Worker name mismatch!"

**Cause**: `CLOUDFLARE_WORKER_NAME` doesn't match `wrangler.jsonc`

**Example Error**:

```
CLOUDFLARE_WORKER_NAME (GitHub Secret): website
Worker name in wrangler.jsonc:          website-staging
```

**Solution**: Either:

1. Update GitHub Secret to match wrangler.jsonc, OR
2. Update wrangler.jsonc to match GitHub Secret

**Important**: Choose the approach based on your intent:

- **Deploy to existing worker**: Update secret to match wrangler.jsonc
- **Deploy to new worker**: Update wrangler.jsonc and create new worker in Cloudflare

### Issue: "Health check failed"

**Cause**: Worker deployed but is not responding (code error, missing dependencies, etc.)

**Solution**:

1. Check Cloudflare Workers Dashboard for error logs
2. Review GitHub Actions logs for build/deployment errors
3. Verify worker code is correct (review recent commits)
4. Check network connectivity and Cloudflare status

### Issue: Worker URL shows as unavailable

**Cause**: DNS/CDN propagation delay or worker not accessible

**Solution**:

1. Wait 30-60 seconds and retry
2. Check that worker was deployed (Cloudflare Dashboard)
3. Verify CORS settings if accessing from frontend
4. Check Cloudflare firewall rules

---

## Related Documentation

- [Cloudflare Workers Deployment Guide](../DEPLOYMENT.md)
- [Wrangler Configuration](https://developers.cloudflare.com/workers/wrangler/configuration/)
- [Cloudflare API Documentation](https://developers.cloudflare.com/api/)
- [GitHub Environment Secrets](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment)

---

## Scripts Reference

### build-worker-url.sh

**Location**: `scripts/build-worker-url.sh`

**Purpose**: Centralized script to construct and validate Worker URL

**Usage**:

```bash
# In GitHub Actions
bash scripts/build-worker-url.sh

# In local scripts
export CLOUDFLARE_WORKER_NAME="website"
bash scripts/build-worker-url.sh
```

**Validation Performed**:

1. ‚úÖ Checks CLOUDFLARE_WORKER_NAME is set
2. ‚úÖ Reads worker name from wrangler.jsonc
3. ‚úÖ Verifies they match (strict validation)
4. ‚úÖ Constructs Worker URL
5. ‚úÖ Outputs for GitHub Actions and scripts

**Exit Codes**:

- `0` = Success
- `1` = Validation failed (see error message for details)

---

## Environment Secrets Summary

### Production Environment Secrets

| Secret Name              | Value             | Where to Find                     |
| ------------------------ | ----------------- | --------------------------------- |
| `CLOUDFLARE_WORKER_NAME` | e.g., `website`   | Your wrangler.jsonc "name" field  |
| `CLOUDFLARE_API_TOKEN`   | Your API token    | Cloudflare Dashboard ‚Üí API Tokens |
| `CLOUDFLARE_ACCOUNT_ID`  | Your account UUID | Cloudflare Dashboard ‚Üí Account ID |

### Where to Configure

All three secrets should be added to:
**GitHub Repository** ‚Üí **Settings** ‚Üí **Environments** ‚Üí **production**

---

Last Updated: 2025-11-11
